// 1. 全局安装 gulp：
// npm install --global gulp
// 2. 作为项目的开发依赖（devDependencies）安装：
// npm install --save-dev gulp

var clean = require("gulp-clean");
var postcss = require("gulp-postcss");
var gulp = require("gulp");
var cssnext = require("postcss-cssnext");
var cssnano = require("cssnano");
var uglify = require("gulp-uglify");
var changed = require("gulp-changed");
var imagemin = require("gulp-imagemin");
var cache = require("gulp-cache"); //使用 gulp-cache 只压缩修改的图片，没有修改的图片直接从缓存文件读取
var pngquant = require("imagemin-pngquant");
var babel = require("gulp-babel");

var minifyCss = "./minifycss/";
var minifyJs = "./minifyjs/";
var minifyImg = "./minifyimg/";

//css压缩
gulp.task("minify:css", function() {
  var plugins = [
    cssnext({
      browsers: ["> 3%", "last 5 versions", "Firefox ESR"],
      warnForDuplicates: false
    }),
    cssnano()
  ];
  return gulp
    .src("./css/*.css")
    .pipe(changed(minifyCss))
    .pipe(postcss(plugins))
    .pipe(gulp.dest(minifyCss));
});

//js压缩
gulp.task("minify:js", function() {
  return gulp
    .src("./js/**/*")
    .pipe(changed(minifyJs))
    .pipe(babel())
    .pipe(uglify())
    .pipe(gulp.dest(minifyJs));
});

//image压缩
gulp.task("minify:img", function() {
  return gulp
    .src("./image/*")
    .pipe(
      cache(
        imagemin(
          [
            imagemin.gifsicle({ interlaced: true }), //类型：Boolean 默认：false 隔行扫描gif进行渲染
            imagemin.jpegtran({ progressive: true }), //类型：Boolean 默认：false 无损压缩jpg图片
            imagemin.optipng({ optimizationLevel: 5 }), //类型：Number  默认：3  取值范围：0-7（优化等级）
            imagemin.svgo({
              plugins: [
                { removeViewBox: true }, // removeViewBox 移除svg的viewbox属性
                { cleanupIDs: false }, // 删除未使用的和缩小使用的ID
                { multipass: true } //类型：Boolean 默认：false 多次优化svg直到完全优化
              ]
            })
          ],
          { use: [pngquant()] }
        )
      )
    )
    .pipe(gulp.dest(minifyImg));
});

// 删除文件
gulp.task("clean", function(cb) {
  return gulp.src(distPath, { read: false }).pipe(clean());
});

gulp.task('default',function(){
   gulp.start('clean','minify:css','minify:js','minify:img');
});

